<div class="room-details-container-minimal p-3">
  <!-- Initial Join/Create Form -->
  <div *ngIf="!isInRoom" class="join-create-form">
    <h5 class="text-center mb-4">ListenTogether</h5>
    
    <div class="mb-3">
      <label for="userName" class="form-label">Your Name</label>
      <input type="text" class="form-control" id="userName" [(ngModel)]="userName" placeholder="Enter your name" maxlength="50">
    </div>
    
    <div class="row g-2 mb-3">
      <div class="col">
        <button class="btn btn-primary w-100" (click)="createRoom()" [disabled]="!userName.trim()">
          Create Room
        </button>
      </div>
    </div>
    
    <hr class="my-3">
    
    <div class="mb-3">
      <label for="joinRoomCode" class="form-label">Room Code</label>
      <input type="text" class="form-control" id="joinRoomCode" [(ngModel)]="joinRoomCode" placeholder="Enter room code" maxlength="10">
    </div>
    
    <div class="row g-2">
      <div class="col">
        <button class="btn btn-outline-primary w-100" (click)="joinRoom()" [disabled]="!userName.trim() || !joinRoomCode.trim()">
          Join Room
        </button>
      </div>
    </div>
  </div>    <!-- Room Details (shown after joining/creating) -->
    <div *ngIf="isInRoom" class="room-content">
      <!-- Top Section: Room Details -->
    <div class="room-details-section">
      <div class="room-code-card mb-3" *ngIf="roomCode">
        <h6 class="room-code-title">Share Room Code</h6>
        <div class="room-code-display-wrapper">
          <div class="room-code-text" id="roomCodeMinimalDisplay">{{ roomCode || 'N/A' }}</div>
          <button class="btn btn-copy-room-code" (click)="copyRoomCode()" title="Copy Room Code">
            <lucide-icon name="copy" size="18"></lucide-icon>
            <span>Copy</span>
          </button>
        </div>
        <input type="text" readonly [value]="roomCode" class="visually-hidden" #roomCodeInputForCopy>
      </div>

      <div class="user-list-section mb-3">
        <h6 class="section-title d-flex align-items-center mb-2">
          <lucide-icon name="users" size="18" class="me-2"></lucide-icon>
          Participants ({{ users.length }})
        </h6>
        <ul class="list-group list-group-flush user-list-minimal-v2">
          <li *ngFor="let user of users; trackBy: trackByUserId" class="list-group-item d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <span class="connection-status me-2" [class.connected]="true" title="Connected">‚óè</span>
              <span class="user-name">{{ user.name }}</span>
              <span *ngIf="user.isHost" class="badge bg-primary ms-2">HOST</span>
            </div>
            <button *ngIf="isRoomAdmin && user.id !== currentUserId" class="btn btn-icon btn-sm btn-ghost-danger" (click)="kickUser(user.id)" title="Kick {{ user.name }}">
              <lucide-icon name="user-x" size="16"></lucide-icon>
            </button>
          </li>
          <li *ngIf="users.length === 0" class="list-group-item text-muted text-center">
            No other participants yet.
          </li>
        </ul>
      </div>

      <div class="room-actions-section mb-3" *ngIf="isRoomAdmin">
        <button class="btn btn-sm btn-danger w-100 d-flex align-items-center justify-content-center" type="button" (click)="endRoom()">
          <lucide-icon name="log-out" size="16" class="me-2"></lucide-icon>
          End Room
        </button>
      </div>
    </div>

    <!-- Divider -->
    <div class="section-divider"></div>

    <!-- Bottom Section: Queue -->
    <div class="queue-section">
      <div class="queue-header mb-3">
        <h6 class="section-title d-flex align-items-center mb-2">
          <lucide-icon name="list-music" size="18" class="me-2"></lucide-icon>
          Queue ({{ queueItems.length }})
        </h6>        <div class="add-music-section">
          <div class="input-group input-group-sm" [class.working-state]="isRoomWorking">
            <span class="input-group-text" [class.working]="isRoomWorking">
              <lucide-icon *ngIf="!isRoomWorking" name="music" size="16"></lucide-icon>
              <div *ngIf="isRoomWorking" class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </span>              <input 
                type="text" 
                class="form-control form-control-sm" 
                id="youtubeUrlMinimal" 
                [placeholder]="isRoomWorking ? 'Server is busy processing...' : 'Paste YouTube or Spotify URL'"
                [(ngModel)]="youtubeUrl" 
                (keyup.enter)="addVideoToQueue()"
                [disabled]="isAddingToQueue || isRoomWorking">
              <button 
                class="btn btn-sm btn-outline-secondary btn-add-music" 
                type="button" 
                (click)="addVideoToQueue()" 
                [disabled]="!youtubeUrl.trim() || isAddingToQueue || isRoomWorking" 
                [title]="isRoomWorking ? 'Server is busy...' : 'Add to Queue'">
              <lucide-icon *ngIf="!isAddingToQueue && !isRoomWorking" name="plus-circle" size="16"></lucide-icon>
              <div *ngIf="isAddingToQueue || isRoomWorking" class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </button>
          </div>
          
          <!-- Status Messages -->
          <div class="status-messages mt-2">
            <!-- Room Working Message (shown to all users) -->
            <div *ngIf="isRoomWorking" class="room-working-message">
              <small class="text-warning">
                <lucide-icon name="clock" size="12" class="me-1"></lucide-icon>
                {{ roomWorkingMessage }} Please wait...
              </small>
            </div>
            
            <!-- Personal Loading Message (shown only to user who clicked) -->
            <div *ngIf="isAddingToQueue && !isRoomWorking" class="personal-loading-message">
              <small class="text-info">
                <lucide-icon name="download" size="12" class="me-1"></lucide-icon>
                Processing your video... This may take a moment.
              </small>
            </div>
            
            <!-- Success Message -->
            <div *ngIf="addToQueueSuccess" class="success-message">
              <small class="text-success">
                <lucide-icon name="check-circle" size="12" class="me-1"></lucide-icon>
                Video added to queue! Download in progress...
              </small>
            </div>
          </div>
        </div>
      </div>

      <div class="queue-list">
        <ul class="list-group list-group-flush queue-items" *ngIf="queueItems.length > 0">
          <li *ngFor="let item of queueItems; let i = index; trackBy: trackByQueueId" 
              class="list-group-item queue-item" 
              [class.currently-playing]="i === currentTrackIndex"
              [class.clickable]="item.downloadStatus === 'completed'"
              (click)="playTrack(i)">
            <div class="queue-item-content">
              <div class="queue-item-info">
                <div class="queue-item-title">{{ item.title || 'Unknown Title' }}</div>
                <div class="queue-item-artist">{{ item.artist || 'Unknown Artist' }}</div>
                <div class="queue-item-meta">
                  <div class="queue-item-duration" *ngIf="item.duration">
                    {{ formatDuration(item.duration) }}
                  </div>
                  <!-- Download Progress -->
                  <div class="download-status" *ngIf="item.downloadStatus && item.downloadStatus !== 'completed'">
                    <span class="download-text" [ngSwitch]="item.downloadStatus">
                      <span *ngSwitchCase="'pending'" class="text-muted">
                        <lucide-icon name="clock" size="12" class="me-1"></lucide-icon>
                        Preparing...
                      </span>
                      <span *ngSwitchCase="'downloading'" class="text-info">
                        <lucide-icon name="download" size="12" class="me-1"></lucide-icon>
                        Downloading {{ item.downloadProgress || 0 }}%
                      </span>
                      <span *ngSwitchCase="'error'" class="text-danger">
                        <lucide-icon name="alert-circle" size="12" class="me-1"></lucide-icon>
                        Download failed
                      </span>
                    </span>
                    <!-- Progress Bar -->
                    <div class="progress mt-1" *ngIf="item.downloadStatus === 'downloading'" style="height: 3px;">
                      <div class="progress-bar" role="progressbar" 
                           [style.width.%]="item.downloadProgress || 0" 
                           [attr.aria-valuenow]="item.downloadProgress || 0" 
                           aria-valuemin="0" aria-valuemax="100">
                      </div>
                    </div>
                  </div>
                  <div class="download-complete" *ngIf="item.downloadStatus === 'completed'">
                    <span class="text-success">
                      <lucide-icon name="check-circle" size="12" class="me-1"></lucide-icon>
                      Ready to play
                    </span>
                  </div>
                </div>
              </div>
              <div class="queue-item-actions">
                <button *ngIf="item.downloadStatus === 'completed' && user" 
                        class="btn btn-icon btn-sm btn-ghost-primary play-btn" 
                        (click)="playTrack(i); $event.stopPropagation()" 
                        [title]="i === currentTrackIndex ? 'Currently playing' : 'Play this track'">
                  <lucide-icon [name]="i === currentTrackIndex ? 'volume-2' : 'play'" size="12"></lucide-icon>
                </button>
                <button *ngIf="isRoomAdmin && i !== currentTrackIndex" 
                        class="btn btn-icon btn-sm btn-ghost-danger" 
                        (click)="removeFromQueue(i); $event.stopPropagation()" 
                        title="Remove from queue">
                  <lucide-icon name="x" size="14"></lucide-icon>
                </button>
              </div>
            </div>
          </li>
        </ul>
        <div *ngIf="queueItems.length === 0" class="empty-queue text-center text-muted py-4">
          <lucide-icon name="music" size="32" class="mb-2"></lucide-icon>
          <p class="mb-0">No songs in queue</p>
          <small>Add a YouTube URL above to get started</small>
        </div>
      </div>
    </div>
  </div>
</div>
