<div *ngIf="isInRoom" [class.collapsed]="!isExpanded && isMobile"
     [class.desktop]="!isMobile"
     [class.expanded]="isExpanded && isMobile"
     [class.mobile]="isMobile"
     class="player-container">
  <audio
    #audioRef
    preload="metadata">
  </audio>

  <div *ngIf="isMobile && !isExpanded" class="mobile-collapsed-modern">
    <div (click)="toggleExpanded()" class="mobile-collapsed-content">
      <div class="mobile-progress-bottom">
        <div
          [class.animate-pulse]="isPlaying"
          [style.width.%]="duration > 0 ? (currentTime / duration) * 100 : 0"
          class="mobile-progress-fill">
        </div>
      </div>

      <div class="mobile-collapsed-inner">
        <div class="mobile-album-icon">
          <lucide-icon name="music" size="16"></lucide-icon>
        </div>

        <div class="mobile-track-info-modern">
          <div class="mobile-title-modern">{{ currentTrack?.title || 'No song' }}</div>
          <div class="mobile-artist-modern">{{ currentTrack?.artist || 'Unknown artist' }}</div>
        </div>

        <button
          (click)="togglePlay(); $event.stopPropagation()"
          [disabled]="!currentUser || !currentTrack || !isTrackReady()"
          [title]="getPlayButtonTitle()"
          class="mobile-play-button-modern">
          <lucide-icon [name]="isPlaying ? 'pause' : 'play'" [size]="16"></lucide-icon>
        </button>
      </div>
    </div>
  </div>
  <div *ngIf="isMobile && isExpanded" class="mobile-expanded-modern">
    <div (click)="closeExpanded()" class="mobile-backdrop"></div>
    <div class="mobile-expanded-content">
      <div class="mobile-gradient-overlay"></div>

      <div class="mobile-expanded-inner">
        <div class="mobile-header-modern">
          <button (click)="closeExpanded()" class="close-btn-modern">
            <lucide-icon name="chevron-down" size="20"></lucide-icon>
          </button>
          <div class="mobile-header-title-modern">Playing from Search</div>
          <button class="more-btn-modern">
            <lucide-icon name="more-horizontal" size="20"></lucide-icon>
          </button>
        </div>

        <div class="mobile-album-section">
          <div class="mobile-album-art-modern">
            <div class="mobile-album-bg-gradient"></div>
            <img *ngIf="currentTrack?.coverUrl"
                 [alt]="currentTrack?.title || 'Album cover'"
                 [src]="currentTrack?.coverUrl"
                 class="mobile-album-image-modern">
            <div *ngIf="!currentTrack?.coverUrl" class="mobile-album-placeholder-modern">
              <lucide-icon name="music" size="80"></lucide-icon>
            </div>
          </div>
        </div>

        <div class="mobile-track-details-modern">
          <h1 class="mobile-track-title-modern">{{ currentTrack?.title || 'No song selected' }}</h1>
          <p class="mobile-track-artist-modern">{{ currentTrack?.artist || 'Unknown artist' }}</p>
        </div>

        <div class="mobile-progress-section-modern">
          <div class="mobile-time-labels-modern">
            <span>{{ formatTime(currentTime) }}</span>
            <div class="mobile-progress-container-modern">
              <div
                (click)="onProgressClick($event); $event.stopPropagation()"
                (mousedown)="onProgressMouseDown($event)"
                [class.dragging]="isDraggingProgress"
                [class.interactive]="currentUser"
                class="mobile-progress-track-modern">
                <div
                  [class.enhanced-gradient]="isDraggingProgress"
                  [style.width.%]="duration > 0 ? (currentTime / duration) * 100 : 0"
                  class="mobile-progress-fill-modern">
                  <div
                    [class.visible]="isDraggingProgress"
                    [style.transform]="'translateY(-50%) translateX(50%)'"
                    class="mobile-progress-handle">
                  </div>
                </div>
              </div>
            </div>
            <span>{{ formatTime(duration) }}</span>
          </div>
        </div>

        <div class="mobile-controls-modern">
          <button
            (click)="previousTrack(); $event.stopPropagation()"
            [disabled]="!currentUser || !hasPreviousTrack()"
            class="mobile-control-btn-modern">
            <lucide-icon name="skip-back" size="24"></lucide-icon>
          </button>

          <button
            (click)="togglePlay(); $event.stopPropagation()"
            [disabled]="!currentUser || !currentTrack || !isTrackReady()"
            class="mobile-play-btn-modern">
            <lucide-icon [name]="isPlaying ? 'pause' : 'play'" [size]="28"></lucide-icon>
          </button>

          <button
            (click)="nextTrack(); $event.stopPropagation()"
            [disabled]="!currentUser || !hasNextTrack()"
            class="mobile-control-btn-modern">
            <lucide-icon name="skip-forward" size="24"></lucide-icon>
          </button>
        </div>

        <div class="mobile-bottom-controls">
          <button
            class="mobile-bottom-btn-modern">
            <lucide-icon name="heart" size="20"></lucide-icon>
          </button>
          <button
            (click)="toggleMute(); $event.stopPropagation()"
            class="mobile-bottom-btn-modern">
            <lucide-icon [name]="getVolumeIcon()" size="20"></lucide-icon>
          </button>
        </div>
      </div>
    </div>
  </div>
  <div *ngIf="!isMobile" class="desktop-player-modern">
    <div class="desktop-progress-top">
      <div
        (click)="onProgressClick($event); $event.stopPropagation()"
        (mousedown)="onProgressMouseDown($event)"
        [class.dragging]="isDraggingProgress"
        [class.interactive]="currentUser"
        class="desktop-progress-track-top">
        <div
          [class.enhanced-gradient]="isDraggingProgress"
          [style.width.%]="duration > 0 ? (currentTime / duration) * 100 : 0"
          class="desktop-progress-fill-top">
          <div
            [class.visible]="isDraggingProgress"
            [style.transform]="'translateY(-50%) translateX(50%)'"
            class="desktop-progress-handle">
          </div>
        </div>
      </div>
    </div>

    <div class="desktop-player-content">
      <div class="desktop-left-section">
        <div class="desktop-album-icon">
          <lucide-icon name="music" size="24"></lucide-icon>
        </div>

        <div class="desktop-track-info">
          <div [title]="currentTrack?.title" class="desktop-song-title">
            {{ currentTrack?.title || 'No song selected' }}
          </div>
          <div [title]="currentTrack?.artist" class="desktop-artist-name">
            {{ currentTrack?.artist || 'Unknown artist' }}
          </div>
        </div>

        <button class="desktop-heart-btn">
          <lucide-icon name="heart" size="16"></lucide-icon>
        </button>
      </div>

      <div class="desktop-center-section">
        <div *ngIf="!isInSync() && isInRoom" class="sync-status-modern">
          <lucide-icon class="spin" name="loader" size="14"></lucide-icon>
          <small>Loading music state...</small>
        </div>

        <div *ngIf="autoplayBlocked && currentTrack && isInRoom" class="autoplay-prompt-modern">
          <div class="autoplay-content">
            <lucide-icon name="volume-x" size="16"></lucide-icon>
            <span>Click to resume playback</span>
            <button (click)="onResumePlayback()" class="resume-btn">
              <lucide-icon name="play" size="14"></lucide-icon>
              Resume
            </button>
          </div>
        </div>

        <div class="desktop-controls">
          <button
            (click)="previousTrack(); $event.stopPropagation()"
            [disabled]="!currentUser || !hasPreviousTrack()"
            class="desktop-control-btn"
            title="Previous track">
            <lucide-icon name="skip-back" size="20"></lucide-icon>
          </button>

          <button
            (click)="togglePlay(); $event.stopPropagation()"
            [class.playing]="isPlaying"
            [disabled]="!currentUser || !currentTrack || !isTrackReady()"
            [title]="getPlayButtonTitle()"
            class="desktop-play-btn">
            <lucide-icon [name]="isPlaying ? 'pause' : 'play'" [size]="20"></lucide-icon>
          </button>

          <button
            (click)="nextTrack(); $event.stopPropagation()"
            [disabled]="!currentUser || !hasNextTrack()"
            class="desktop-control-btn"
            title="Next track">
            <lucide-icon name="skip-forward" size="20"></lucide-icon>
          </button>
        </div>

        <div class="desktop-time-section">
          <span class="desktop-time">{{ formatTime(currentTime) }}</span>
          <span class="desktop-time-separator">â€¢</span>
          <span class="desktop-time">{{ formatTime(duration) }}</span>
        </div>
      </div>

      <div class="desktop-right-section">
        <button
          (click)="toggleMute(); $event.stopPropagation()"
          [title]="isMuted ? 'Unmute' : 'Mute'"
          class="desktop-volume-btn">
          <lucide-icon [name]="getVolumeIcon()" size="16"></lucide-icon>
        </button>

        <div class="desktop-volume-container">
          <div
            (click)="onVolumeClick($event); $event.stopPropagation()"
            (mousedown)="onVolumeMouseDown($event)"
            [class.dragging]="isDraggingVolume"
            class="desktop-volume-track">
            <div
              [style.width.%]="isMuted ? 0 : volume * 100"
              class="desktop-volume-fill">
            </div>
          </div>
        </div>

        <button class="desktop-more-btn">
          <lucide-icon name="more-horizontal" size="16"></lucide-icon>
        </button>
      </div>
    </div>
  </div>
</div>
